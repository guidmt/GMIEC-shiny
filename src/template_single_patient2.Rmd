---
title: "VIS-GMIEC output"
author: GMIEC
output: 
  html_document:
    theme: journal
params:
  patient: 
  value: x
---

### Welcome! This is the report of your analysis.
  
## Results for the current patient
This section will contain the results of GMIEC for the current patient.
You will be able to see

- tables with the genes in each module (links to NCBI)
- tables with the drugs in each module (links to DGIdb)

```{r message=F,include=TRUE, echo=FALSE, results='asis', warning=FALSE}

tab_patient<-params$patient

idx_module_genes<-grep(tab_patient[,1],pattern="genes_in_module")
idx_module_drugs<-grep(tab_patient[,1],pattern="drugs_in_module")
idx_number_sad<-grep(tab_patient[,1],pattern="sad")


  
df_genes_drugs<-data.frame(sad=tab_patient[idx_number_sad,2],genes=tab_patient[idx_module_genes,2],drugs=tab_patient[idx_module_drugs,2])
  
 for (i in 1:nrow(df_genes_drugs)){
  sad_in_current_module<-df_genes_drugs[i,1]
  genes_in_current_module<-df_genes_drugs[i,2]
  drugs_in_current_module<-df_genes_drugs[i,3]
  
  subdf<-data.frame(module=as.character(paste("Module",i)),sad=sad_in_current_module)

 print( subdf %>%
  mutate(
    module = cell_spec(module,background = "orange", color = "white", align = "center"),
    sad = color_tile("orange4", "cyan4")(sad) 
  ) %>%
    
  kable(escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(c(1,2), width = "4cm") %>%
  row_spec(1,align='left',color="black")%>%
  row_spec(c(0,1),color="black",align='center',font_size=30))


cat('\n')

#handle genes
split_genes<-strsplit(as.character(genes_in_current_module),split=",")[[1]]
if(!is.null(split_genes)){
#i add na to reduce probles in creation matrix
length(split_genes) <- prod(dim(matrix(split_genes, ncol = 8)))

links_genes<-NULL

#create a vector with the urls gene from Ncbi
for(current_gene in split_genes){
  lg<-paste("www.ncbi.nlm.nih.gov/gene/?term=",current_gene,sep="")
  lg2<-paste0("[", current_gene, "](https://", lg, ")")
  links_genes<-c(links_genes,lg2)
  
}

dfGenes<-data.frame(matrix(links_genes, ncol = 8, byrow = TRUE))
colnames(dfGenes)<-NULL
#finish to create the table with the links

print(kable(dfGenes) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)%>%
  row_spec(1:nrow(dfGenes),color="black"))
#dfGenes$website <- paste0("[", split_genes, "](https://", links_genes, ")")
}

cat('\n')

###
### Do the same for drugs
###

#handle genes
split_drugs<-strsplit(as.character(drugs_in_current_module),split="#")[[1]]
split_drugs2<-unlist(strsplit(as.character(split_drugs),split="@"))

if(!is.null(split_drugs2)){
  
length(split_drugs2) <- prod(dim(matrix(split_drugs2, ncol = 8)))


links_drugs<-NULL

#create a vector with the urls gene from Ncbi
for(current_drug in split_drugs2){
  ld<-paste("www.dgidb.org/drugs/",current_drug,"#_interactions",sep="")
  ld2<-paste0("[", current_drug, "](http://", ld, ")")
  links_drugs<-c(links_drugs,ld2)
  
}

dfDrugs<-data.frame(matrix(links_drugs, ncol = 8, byrow = TRUE))
colnames(dfDrugs)<-NULL

print(kable(dfDrugs) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)%>%
  row_spec(1:nrow(dfDrugs),color="black"))

}

}
```

